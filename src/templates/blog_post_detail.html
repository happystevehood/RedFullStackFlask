{% extends "base.html" %}

{% block title %}{{ post.headline }}{% endblock %}

{% block head %}
{{ super() }}
<meta name="description" content="{{ post.text | striptags | truncate(160) }}">
<meta property="og:title" content="{{ post.headline }}">
<meta property="og:description" content="{{ post.text | striptags | truncate(160) }}">
{% if post.image_filenames and post.image_filenames[0] %} {# Use first image for OG tag #}
<meta property="og:image" content="{{ url_for('blog_post_image', slug=post.slug, filename=post.image_filenames[0], _external=True) }}">
{% endif %}
<meta property="og:url" content="{{ url_for('blog_post_detail', slug=post.slug, _external=True) }}">
<meta property="og:type" content="article">
<style nonce="{{ csp_nonce() }}">
    .blog-image-thumbnail-link {
        display: inline-block; /* Allows figure to behave better with margin */
        text-decoration: none;
    }
    .blog-image-thumbnail {
        cursor: pointer;
        transition: opacity .2s ease-in-out;
        max-width: 100%;
        height: auto;
        border: 1px solid #ddd;
        padding: 4px;
    }
    .blog-image-thumbnail:hover {
        opacity: 0.8;
    }
    .figure-caption {
        font-size: 0.9em;
        color: #6c757d;
    }
    #imageModal .modal-lg { max-width: 85%; }
    #imageModal .modal-body img {
        max-height: 80vh; /* Limit image height in modal */
        width: auto;      /* Maintain aspect ratio */
        max-width: 100%;  /* Ensure it doesn't overflow modal width */
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <article class="blog-post">
        <h1 class="display-5 fw-bold">{{ post.headline }}</h1>
        <p class="blog-post-meta text-muted">
            Posted on {{ post.created_at | format_datetime('%B %d, %Y at %H:%M') }}
            {% if post.created_at != post.updated_at %}
                (Last updated: {{ post.updated_at | format_datetime('%B %d, %Y at %H:%M') }})
            {% endif %}
        </p>
        <hr>

        {% if post.image_filenames %}
        <div class="row mb-4">
            {% for image_filename in post.image_filenames %}
            <div class="col-md-4 col-sm-6 mb-3 d-flex align-items-stretch">
                <figure class="figure text-center w-100">
                    {# --- Get caption for this image, default to "Figure X" if blank --- #}
                    {% set current_caption = post.image_captions[loop.index0] if post.image_captions and loop.index0 < post.image_captions|length else "" %}
                    {% set display_caption = current_caption|trim if current_caption|trim else "Figure " ~ loop.index %}
                    
                    <a href="#" class="blog-image-thumbnail-link"
                       data-bs-toggle="modal" 
                       data-bs-target="#imageModal"
                       data-fullsize-src="{{ url_for('blog_post_image', slug=post.slug, filename=image_filename) }}"
                       data-caption="{{ display_caption }}"> {# Use display_caption for modal #}
                        <img src="{{ url_for('blog_post_image', slug=post.slug, filename=thumbnail_prefix ~ image_filename) }}"
                             class="figure-img img-fluid rounded shadow-sm blog-image-thumbnail"
                             alt="{{ display_caption }} - Thumbnail"> {# Use display_caption for alt text #}
                    </a>
                    <figcaption class="figure-caption">{{ display_caption }}</figcaption> {# Display final caption #}
                </figure>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="blog-content lead">
            {{ post.text | safe }}
        </div>
        
        <div class="text-muted mt-4 pt-2 border-top">
            <small>Viewed {{ post.view_count | default(0) }} times.</small>
        </div>
        <hr>
        <a href="{{ url_for('blog_index') }}" class="btn btn-outline-secondary">Â« Back to Blog Index</a>
    </article>
</div>

<!-- Bootstrap Modal for Image Lightbox (modal title will now use the display_caption) -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Image Preview</h5> {# This will be updated by JS #}
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" id="fullImageInModal" class="img-fluid" alt="Full-size image">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script nonce="{{ csp_nonce() }}">
document.addEventListener('DOMContentLoaded', function () {
    var imageModal = document.getElementById('imageModal');
    if (imageModal) {
        imageModal.addEventListener('show.bs.modal', function (event) {
            var triggerElement = event.relatedTarget;
            var fullsizeSrc = triggerElement.getAttribute('data-fullsize-src');
            var captionFromData = triggerElement.getAttribute('data-caption'); // This now gets the potentially "Figure X" caption

            var modalTitle = imageModal.querySelector('.modal-title');
            var modalImage = imageModal.querySelector('#fullImageInModal');

            modalTitle.textContent = captionFromData; // Use the caption from data-caption
            modalImage.src = fullsizeSrc;
            modalImage.alt = captionFromData; // Also set alt text for modal image
        });
        imageModal.addEventListener('hidden.bs.modal', function() {
            var modalImage = imageModal.querySelector('#fullImageInModal');
            modalImage.src = ''; 
        });
    }
});
</script>
{% endblock %}