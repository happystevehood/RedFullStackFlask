{% extends "base.html" %}

{% block title %}{{ legend }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ legend }}</h2>
    <hr>
    {# Standard flash message rendering (ensure you have _flashes.html or similar) #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="headline" class="form-label">Headline</label>
            <input type="text" class="form-control" id="headline" name="headline" value="{{ form_data.headline if form_data else (post.headline if post else '') }}" required>
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">Content (HTML allowed)</label>
            <textarea class="form-control" id="content" name="content" rows="10" required>{{ form_data.content if form_data else (post.text if post else '') }}</textarea>
        </div>

        <fieldset class="mb-3 border p-3">
            <legend class="w-auto px-2 h6">Images (1 to {{ max_images_per_post_const }})</legend>
            
            {% if post %} {# --- EDITING EXISTING POST --- #}
                {# ... (existing image deletion logic) ... #}
                {% if current_images_for_form %}
                    <h6>Current Images:</h6>
                    <div class="row mb-3">
                        {% for filename in current_images_for_form %}
                        <div class="col-md-6 col-lg-4 mb-3"> {# Adjusted column for caption field #}
                            <div class="card">
                                <img src="{{ url_for('blog_post_image', slug=post.slug, filename=thumbnail_prefix ~ filename) }}?v={{ post.updated_at|replace(':', '')|replace('-', '') }}" 
                                     class="card-img-top" alt="Current Image {{ loop.index }}" style="max-height: 120px; object-fit: contain; padding: 5px;">
                                <div class="card-body p-2">
                                    <p class="card-text small text-truncate" title="{{ filename }}">{{ filename }}</p>
                                    {# Caption for existing image #}
                                    <div class="mb-2">
                                        <label for="current_caption_{{ loop.index0 }}" class="form-label form-label-sm visually-hidden">Caption for Image {{loop.index}}</label>
                                        <input type="text" class="form-control form-control-sm" 
                                                id="current_caption_{{ loop.index0 }}" 
                                                name="current_caption_{{ loop.index0 }}" 
                                                placeholder="Caption for Image {{ loop.index }} (optional)" 
                                                value="{{ current_captions_for_form[loop.index0] if current_captions_for_form and loop.index0 < current_captions_for_form|length else '' }}">
                                                
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="delete_image_{{ loop.index0 }}" id="delete_image_{{ loop.index0 }}">
                                        <label class="form-check-label small" for="delete_image_{{ loop.index0 }}">
                                            Delete Image {{ loop.index }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <hr class="my-3">
                {% endif %}
                
                <h6>Add New Images:</h6>
                {# ... (existing new image upload slots) ... #}
                 {% for i in range(max_images_per_post_const) %}
                <div class="row mb-2 align-items-center">
                    <div class="col-md-6">
                        <label for="new_image_{{ i }}" class="form-label form-label-sm visually-hidden">New Image File {{ i + 1 }}</label>
                        <input type="file" class="form-control form-control-sm" id="new_image_{{ i }}" name="new_image_{{ i }}" accept="image/*">
                    </div>
                    <div class="col-md-6">
                         <label for="new_caption_{{ i }}" class="form-label form-label-sm visually-hidden">Caption for New Image {{ i + 1 }}</label>
                        <input type="text" class="form-control form-control-sm" 
                            id="new_caption_{{ i }}" 
                            name="new_caption_{{ i }}" 
                            placeholder="Caption for new image {{ i + 1 }} (optional)">
                    </div>
                </div>
                {% endfor %}


            {% else %} {# --- CREATING NEW POST --- #}
                <p class="small text-muted">Upload at least one image. All uploaded images will be included up to {{ max_images_per_post_const }}.</p>
                {% for i in range(max_images_per_post_const) %}
                <div class="row mb-3 align-items-center">
                    <div class="col-md-6">
                        <label for="image_{{ i }}" class="form-label">Image {{ i + 1 }} {% if i == 0 %}<span class="text-danger small">(Required)</span>{% else %}(Optional){% endif %}</label>
                        <input type="file" class="form-control" id="image_{{ i }}" name="image_{{ i }}" accept="image/*">
                    </div>
                    <div class="col-md-6">
                        <label for="caption_{{ i }}" class="form-label">Caption for Image {{ i + 1 }} (Optional)</label>
                        <input type="text" class="form-control" id="caption_{{ i }}" name="caption_{{ i }}" placeholder="Enter caption">
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </fieldset>       

        {# --- New Published Checkbox --- #}
        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="is_published" name="is_published" value="true" 
                   {% if (form_data and form_data.is_published) or (post and post.is_published) or (not post and not form_data) %}checked{% endif %}>
            <label class="form-check-label" for="is_published">Publish Post (visible to users)</label>
        </div>
        {# --- End Published Checkbox --- #}

        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="is_featured" name="is_featured" value="true" {% if (form_data and form_data.is_featured) or (post and post.is_featured) %}checked{% endif %}>
            <label class="form-check-label" for="is_featured">Feature on Homepage?</label>
        </div>

        <button type="submit" class="btn btn-primary">{% if post %}Update{% else %}Create{% endif %} Post</button>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <a href="{{ url_for('manage_blog_posts') }}" class="btn btn-secondary">Cancel</a>
    </form>
    <p class="mt-3">
        <a href="{{ url_for('manage_blog_posts') }}" class="btn btn-info">Manage All Posts</a>
    </p>
</div>
{% endblock %}