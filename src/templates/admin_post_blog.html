{% extends "base.html" %}

{% block title %}{{ legend }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ legend }}</h2>
    <hr>
    {# Standard flash message rendering (ensure you have _flashes.html or similar) #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="headline" class="form-label">Headline</label>
            <input type="text" class="form-control" id="headline" name="headline" value="{{ form_data.headline if form_data else (post.headline if post else '') }}" required>
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">Content (HTML allowed)</label>
            <textarea class="form-control" id="content" name="content" rows="10" required>{{ form_data.content if form_data else (post.text if post else '') }}</textarea>
        </div>

        <fieldset class="mb-3 border p-3">
            <legend class="w-auto px-2 h6">Images (1 to {{ max_images_per_post_const }})</legend>
            
            {% if post %} {# --- EDITING EXISTING POST --- #}
                <p class="small text-muted">Manage current images below. A post must have at least one image. Upload new images in the "Add New Images" section.</p>
                {% if current_images_for_form %}
                    <h6>Current Images:</h6>
                    <div class="row mb-3">
                        {% for filename in current_images_for_form %}
                        <div class="col-md-4 col-lg-3 col-sm-6 mb-3">
                            <div class="card">
                                <img src="{{ url_for('blog_post_image', slug=post.slug, filename=thumbnail_prefix ~ filename) }}?v={{ post.updated_at|replace(':', '')|replace('-', '') }}" 
                                     class="card-img-top" alt="Current Image {{ loop.index }}" style="max-height: 120px; object-fit: contain; padding: 5px;">
                                <div class="card-body p-2">
                                    <p class="card-text small text-truncate" title="{{ filename }}">{{ filename }}</p>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="delete_image_{{ loop.index0 }}" id="delete_image_{{ loop.index0 }}">
                                        <label class="form-check-label small" for="delete_image_{{ loop.index0 }}">
                                            Delete Image {{ loop.index }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <hr class="my-3">
                {% else %}
                    <p class="text-warning">No current images for this post.</p>
                {% endif %}
                
                <h6>Add New Images:</h6>
                <p class="small text-muted">Upload new files here. Max {{ max_images_per_post_const }} total images (including existing ones not marked for deletion).</p>
                {% set num_existing_images = current_images_for_form|length if current_images_for_form else 0 %}
                {% for i in range(max_images_per_post_const) %} {# Always show max_images_per_post_const slots for adding #}
                <div class="mb-2">
                    <label for="new_image_{{ i }}" class="form-label small">
                        New Image Slot {{ i + 1 }}
                    </label>
                    <input type="file" class="form-control form-control-sm" id="new_image_{{ i }}" name="new_image_{{ i }}" accept="image/*">
                </div>
                {% endfor %}

            {% else %} {# --- CREATING NEW POST --- #}
                <p class="small text-muted">Upload at least one image (required for new post). All uploaded images will be included up to {{ max_images_per_post_const }}.</p>
                {% for i in range(max_images_per_post_const) %}
                <div class="mb-3">
                    <label for="image_{{ i }}" class="form-label">Image {{ i + 1 }} {% if i == 0 %}<span class="text-danger small">(Required for new post)</span>{% else %}(Optional){% endif %}</label>
                    <input type="file" class="form-control" id="image_{{ i }}" name="image_{{ i }}" accept="image/*" {% if i == 0 %}{# No 'required' attribute here, backend handles "at least one" #}{% endif %}>
                </div>
                {% endfor %}
            {% endif %}
        </fieldset>

        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="is_featured" name="is_featured" value="true" {% if (form_data and form_data.is_featured) or (post and post.is_featured) %}checked{% endif %}>
            <label class="form-check-label" for="is_featured">Feature on Homepage?</label>
        </div>

        <button type="submit" class="btn btn-primary">{% if post %}Update{% else %}Create{% endif %} Post</button>
        <a href="{{ url_for('manage_blog_posts') }}" class="btn btn-secondary">Cancel</a>
    </form>
    <p class="mt-3">
        <a href="{{ url_for('manage_blog_posts') }}" class="btn btn-info">Manage All Posts</a>
    </p>
</div>
{% endblock %}