{% extends "base.html" %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">Redline Results Search</h1>

    <div id="searchui">
        <h2 class="mb-3">Enter Competitor Name:</h2>

        <form id="newSearchForm" class="row gy-2 gx-3 align-items-center mb-4">
            <div class="col-auto">
                <label for="competitorToSearch" class="visually-hidden">Competitor Name</label>
                <input type="text" class="form-control" id="competitorToSearch" name="competitor" placeholder="Joe Bloggs" style="min-width: 250px;">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>

        <div id="searchDetail" class="mb-3">
            <p id="SearchResults" class="h5" ></p>
        </div>

        <div id="display" class="border rounded p-3 mb-3" style="background-color: #f9f9f9;"></div>

    </div>
</div>
{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
    let itemsRaw = [];

    function displaySearchResults(data) {
        const $searchDetail = $('#searchDetail').show();
        const $display = $('#display').empty();
        const $results = $('#SearchResults').empty();
        const toSearch = $('#competitorToSearch').val();

        if (data.length === 0) {
            $results.text(`No matches found for "${toSearch}".`);
            return;
        } else if (data.length === 100) {
            $results.text(`Success! At least ${data.length} matches found! Click a name to get more details:`);
        } else {
            $results.text(`Success! ${data.length} matches found! Click a name to get more details:`);
        }

        const $ul = $('<ul/>', { class: 'list-group' });

        data.slice(0, 25).forEach((val, i) => {
            $('<li/>', {
                class: 'list-group-item list-group-item-action',
                id: i,
                text: `${val.competitor} - ${val.description} - ${val.race_no}`,
                css: { cursor: 'pointer' }
            }).appendTo($ul);
        });

        $ul.appendTo($display);

        if (data.length > 25) {
            $('<p/>', {
                text: `...Please refine your search criteria.`,
                class: 'text-danger mt-2'
            }).appendTo($display);
        }
    }

    function fetchInitialResults() {
        $.getJSON('/api/search')
            .done(data => {
                if (data === 'No matches found') {
                    console.log('No matches found');
                    return;
                }
                console.log('Initial data received:', data);
                itemsRaw = data;
                displaySearchResults(data);
            })
            .fail(err => {
                console.error('Failed to fetch initial search data:', err);
            });
    }

    $('#newSearchForm').on('submit', function(e) {
        e.preventDefault();
        console.log('Submitting new search...');

        $.post('/api/search', $(this).serialize())
            .done(response => {
                if (response.data?.length) {
                    console.log('Search successful:', response.data);
                    itemsRaw = response.data;
                    displaySearchResults(response.data);
                } else {
                    console.log('No matches found in new search.');
                    displaySearchResults([]);
                }
                $('#competitorToSearch').val(''); // Clear input
            })
            .fail(err => {
                console.error('Search request failed:', err);
            });
    });

    $('#display').on('click', '.list-group-item', function() {
        const selected = itemsRaw[this.id];
        if (!selected) return;
        console.log('Competitor selected:', selected);

        const query = $.param({
            competitor: selected.competitor,
            year: selected.year,
            race_no: selected.race_no,
            event: selected.event
        });

        window.location.href = `/display_vis?${query}`;
    });

    // Initial load
    fetchInitialResults();
});
</script>
{% endblock %}