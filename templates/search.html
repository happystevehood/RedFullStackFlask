{% extends "base.html" %}
    {% block head %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% endblock %}

    {% block content %}
        <h1>Redline Results Search</h1>
        <div id='searchui'>
            <h2 style="text-align: left">Enter Competitor name in search bar:-</h2>

            <form id="newSearchForm" class="border" >
                <label for="competitorToSearch">Competitor Name</label>
                <input type="text" id="competitorToSearch" name="competitor" placeholder="Joe Bloggs" style="width: 295px">
                <button type="submit" value="Submit" id="newSearch">Search for Competitor...</button>
            </form>

            <div id='searchDetail'  hidden>
                <p id='SearchResults'>SearchResults</p>
            </div>
            
            <div id='display' class='border' hidden>display</div>
            
            <div id='searchCandidate' class='border'  style="display:none;" >
                <p id='candidateData' style="display:none;" >This is the selected competitor:</p>
                <button id='clearSearch' style="display:none;" >Clear Search...</button>
            </div>
        </div>
    {% endblock %}

    {% block script %}
    <script>
    $(document).ready(function() {
        let itemsRaw = [];
    
        // Utility function to display results
        function displaySearchResults(data) {
            const $searchDetail = $('#searchDetail').show();
            const $display = $('#display').empty().show();
            const $results = $('#SearchResults').empty();
            const toSearch = $('#competitorToSearch').val()
    
            if (data.length === 0) {
                $results.text(`No matches found for ${toSearch}`);
                return;
            }
            //stop counting match after this.
            else if(data.length === 100)
            {
                $results.text(`Success! At least ${data.length} matches found! Click on individual name to get more details:`);
            }
            else 
            {
                $results.text(`Success! ${data.length} matches found! Click on individual name to get more details:`);
            }
             
            const $ul = $('<ul/>', { class: 'listWrapper' });
    
            data.slice(0, 25).forEach((val, i) => {
                $('<li/>', {
                    class: 'competitorItem',
                    id: i,
                    text: `${val.competitor} - ${val.description} - ${val.race_no}`,
                    css: { color: 'blue', cursor: 'pointer' }
                }).appendTo($ul);
            });
    
            if (data.length > 25) {
                $('<p/>', {
                    text: `...Please refine search criteria as needed`,
                    css: { color: 'red' }
                }).appendTo($display);
            }
    
            $ul.appendTo($display);
        }
    
        // Fetch initial data
        function fetchInitialResults() {
            $.getJSON('/api/search')
                .done(data => {
                    if (data === 'No matches found') {
                        console.log('No matches found');
                        return;
                    }
                    console.log('Initial data received:', data);
                    itemsRaw = data;
                    displaySearchResults(data);
                })
                .fail(err => {
                    console.error('Failed to fetch initial search data:', err);
                });
        }
    
        // New search
        $('#newSearchForm').on('submit', function(e) {
            e.preventDefault();
            console.log('Submitting new search...');
    
            $.post('/api/search', $(this).serialize())
                .done(response => {
                    if (response.data?.length) {
                        console.log('Search successful:', response.data);
                        itemsRaw = response.data;
                        displaySearchResults(response.data);
                    } else {
                        console.log('No matches found in new search.');
                        displaySearchResults([]);
                    }
                    $('#competitorToSearch').val(''); // Clear the input field
                })
                .fail(err => {
                    console.error('Search request failed:', err);
                });
        });
    
        // Handle click on competitor
        $('#display').on('click', '.competitorItem', function() {
            const selected = itemsRaw[this.id];
            if (!selected) return;
            console.log('Competitor selected:', selected);
    
            const query = $.param({
                competitor: selected.competitor,
                year: selected.year,
                race_no: selected.race_no,
                event: selected.event
            });
    
            window.location.href = `/display_vis?${query}`;
        });
    
        // Clear search
        $('#clearSearch').on('click', function() {
            console.log('Clearing search...');
            $.ajax({
                url: '/api/search/',
                type: 'DELETE'
            }).done(() => {
                $('#searchDetail, #display, #searchCandidate, #candidateData, #clearSearch').hide();
                itemsRaw = [];
            }).fail(err => {
                console.error('Failed to clear search:', err);
            });
        });
    
        // Load existing results on page load
        fetchInitialResults();
    });
    </script>
    {% endblock %}